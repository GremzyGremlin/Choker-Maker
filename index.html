  function getCheckedValues(containerId) {
    return Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(el => el.value);
  }

  function updatePreview() {
    const leather = document.getElementById("leather").value;
    const spikeColors = getCheckedValues("spikeColorsChecklist");
    const chainStyle = document.getElementById("chainStyle").value;
    const chainColorMode = document.getElementById("chainColorMode").value;
    const chainColors = getCheckedValues("chainColorsChecklist");
    const pendant = document.getElementById("pendant").value;

    // Update leather preview
    const leatherBar = document.getElementById("leatherBar");
    leatherBar.style.backgroundColor = colorMap[leather];

    // Update spikes preview
    const spikeOverlay = document.getElementById("spikeOverlay");
    spikeOverlay.innerHTML = "";
    spikeColors.forEach(() => {
      const spike = document.createElement('div');
      spike.className = 'spike';
      spike.style.backgroundColor = "#000";  // Spike color can be customized if needed
      spikeOverlay.appendChild(spike);
    });

    // Update chain preview
    const chainPreview = document.getElementById("chainPreview");
    chainPreview.innerHTML = "";
    const chainColor = chainColorMode === 'alternating' ? chainColors : chainColors.slice(0, chainColors.length / 2);
    chainColor.forEach(color => {
      const chainSymbol = document.createElement('div');
      chainSymbol.className = 'chain-symbol';
      chainSymbol.style.backgroundColor = colorMap[color];
      chainPreview.appendChild(chainSymbol);
    });

    // Update pendant preview
    const pendantPreview = document.getElementById("pendantPreview");
    pendantPreview.innerHTML = colorMap[pendant] || "None";
    pendantPreview.style.color = colorMap[pendant] || "transparent";
  }

  // Save order
  function saveOrder() {
    const leather = document.getElementById("leather").value;
    const spikeColors = getCheckedValues("spikeColorsChecklist");
    const chainStyle = document.getElementById("chainStyle").value;
    const chainColorMode = document.getElementById("chainColorMode").value;
    const chainColors = getCheckedValues("chainColorsChecklist");
    const pendant = document.getElementById("pendant").value;

    const order = {
      leather,
      spikeColors,
      chainStyle,
      chainColorMode,
      chainColors,
      pendant
    };

    const orders = JSON.parse(localStorage.getItem("orders")) || [];
    orders.push(order);
    localStorage.setItem("orders", JSON.stringify(orders));
    displaySavedOrders();
  }

  // Display saved orders
  function displaySavedOrders() {
    const orders = JSON.parse(localStorage.getItem("orders")) || [];
    const responsesList = document.getElementById("responsesList");
    responsesList.innerHTML = "<h3>Previous Custom Orders</h3>";
    orders.forEach(order => {
      const entry = document.createElement("div");
      entry.classList.add("entry");
      entry.innerHTML = `
        <p><strong>Leather:</strong> ${order.leather}</p>
        <p><strong>Spikes:</strong> ${order.spikeColors.join(", ")}</p>
        <p><strong>Chain Style:</strong> ${order.chainStyle}</p>
        <p><strong>Chain Color Mode:</strong> ${order.chainColorMode}</p>
        <p><strong>Chain Colors:</strong> ${order.chainColors.join(", ")}</p>
        <p><strong>Pendant:</strong> ${order.pendant}</p>
      `;
      responsesList.appendChild(entry);
    });
  }

  // Save image
  function saveImage() {
    html2canvas(document.getElementById("preview")).then(function(canvas) {
      const link = document.createElement("a");
      link.download = "choker-customization.png";
      link.href = canvas.toDataURL();
      link.click();
    });
  }

  // Initialize the form with default data
  window.onload = function() {
    populateSelect("leather", leatherColors);
    populateSelect("pendant", starPendants);
    populateChecklist("spikeColorsChecklist", spikeColors);
    populateChecklist("chainColorsChecklist", chunkyChainColors);

    // Load saved responses
    displaySavedOrders();

    // Update preview based on current form values
    updatePreview();

    // Add event listeners for form changes
    document.querySelectorAll("select, input[type='checkbox']").forEach(el => {
      el.addEventListener("change", updatePreview);
    });

    // Event listener for save image button
    document.getElementById("saveImageBtn").addEventListener("click", saveImage);

    // Event listener for save order
    document.getElementById("saveImageBtn").addEventListener("click", saveOrder);
  };
</script>
</body>
</html>
