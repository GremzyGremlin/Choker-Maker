<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Choker Customizer | Full Symmetric Patterns & Updated Colors</title>
<style>
  :root {
    /* Updated colors based on your detailed specification and spreadsheet */
    /* Base Colors (Leather) */
    --black: #111111;
    --bw-stitch-black: #0e0e0e;
    --white-leather: #f3f3f2; /* off-white for light mode, slightly gray */
    --blue-leather: #236cd1;
    --sky-blue-leather: #a5d5f6;
    --red-leather: #d92126;
    --pink-leather: #f1777f;
    --purple-leather: #804baf;

    /* Spikes (in rainbow order) */
    --red-spikes: #dc1c12;
    --orange-spikes: #db7c2e;
    --yellow-spikes: #f3e763;
    --gold-spikes: #ffef63;
    --green-spikes: #6ac933;
    --sky-blue-spikes: #64c4d6;
    --blue-spikes: #236cd1;
    --purple-spikes: #8829b8;
    --hot-pink-spikes: #ff66aa;
    --light-pink-spikes: #ffa2b8;
    --pink-spikes: #eb62b9;
    --white-spikes: #f3f3f3;
    --gunmetal-spikes: #464a42;
    --black-spikes: #000000;
    
    /* Glow in the Dark Star */
    --blue-glow-in-the-dark-star: #64C4D6;
    --green-glow-in-the-dark-star: #A1BF6C;
    --orange-glow-in-the-dark-star: #DAA966;
    --peach-glow-in-the-dark-star: #D79976;
    --pink-glow-in-the-dark-star: #C85F6F;
    --purple-glow-in-the-dark-star: #AE6FA0;
    --white-glow-in-the-dark-star: #CDC9B6;


    /* Small Chains with full colors */
    --orange: #E28F74;
    --solid-green: #7BD35D;
    --solid-hot-pink: #D03C6C;
    --solid-pink: #CF8499;
    --solid-purple: #a263af;
    --solid-teal: #7be4d6;
    --translucent-green: hsl(83, 65%, 65%);
    --translucent-lavender: #b699e6;
    --translucent-orange: #ECB88A;
    --translucent-pink: #e6a2c7;
    --translucent-salmon: #e68787;
    --translucent-sky-blue: hsl(174, 91%, 69%);
    --translucent-teal: hsl(157, 59%, 65%);
    --translucent-yellow: #D7D07B;
    --white-small-chain: #F7F3EA;

    /* Chunky Chains with full colors */
    --black-chunky: #1b1a19;
    --blue-chunky: #253271;
    --brown-chunky: #774429;
    --green-chunky: hsl(115, 52%, 49%);
    --orange-chunky: #ff830f;
    --pink-chunky: #E79394;
    --purple-chunky: hsl(280, 51%, 61%);
    --red-chunky: #D22A25;
    --sky-blue-chunky: #48C3E9;
    --teal-chunky: hsl(155, 53%, 63%);
    --white-chunky: #E1DDCC;



    /* Pendant Colors */
    --light-pendant: #f3f3f2;
    --dark-pendant: #444444;

    /* UI */
    --container-bg-light: #f3f3f3bb; /* off-white transparent */
    --container-bg-dark: #1e1e1edd;
    --container-border-light: #999;
    --container-border-dark: #444;

    /* UI Colors */
    --sakura-pink: #ffb7c5;
    --sakura-pink-dark: #ff9eb1;

    /* Scrollbar Colors */
    --scrollbar-bg: rgba(255, 183, 197, 0.05);
    --scrollbar-thumb: var(--sakura-pink);
  }

/* Custom Scrollbar Styles */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: var(--scrollbar-bg);
  border-radius: 10px;
  margin: 2px;
}

::-webkit-scrollbar-thumb {
  background: var(--sakura-pink);
  border: 2px solid rgba(0, 0, 0, 0.1);
  border-radius: 10px;
  background-clip: padding-box;
  transition: background 0.3s;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--sakura-pink-dark);
  border: 2px solid rgba(0, 0, 0, 0.1);
  background-clip: padding-box;
}

/* Firefox Scrollbar */
* {
  scrollbar-width: thin;
  scrollbar-color: var(--sakura-pink) var(--scrollbar-bg);
}

/* Firefox - more specific styling */
html {
  scrollbar-width: thin;
  scrollbar-color: var(--sakura-pink) var(--scrollbar-bg);
}

  html, body {
    height: 100%;
    margin: 0;
    overflow: hidden;
  }

  body {
    font-family: Arial, monospace;
    background-color: #121212;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    transition: background-color 0.3s, color 0.3s;
    min-height: 100vh;
  }

  body.light {
    background-color: var(--container-bg-light);
    color: #333;
  }

  .container-wrapper {
    position: relative;
    max-width: 800px;
    width: 100%;
  }

  #modeToggle {
    position: absolute;
    top: 3rem;
    left: -4rem;
    font-size: 1.8rem;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    user-select: none;
    z-index: 9999;
    width: 3rem;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .container {
    max-width: 800px;
    width: 100%;
    max-height: 55vh;
    overflow-y: auto;
    background-color: var(--container-bg-dark);
    border-radius: 12px;
    padding: 1rem 2.5rem 1.5rem 2.5rem;
    box-sizing: border-box;
    border: 2px solid var(--container-border-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: background-color 0.3s, border-color 0.3s;
    margin-top: 1.75rem;
  }
  
  #modeToggle:focus-visible {
    outline-offset: 2px;
    outline: 2px solid var(--sakura-pink);
    border-radius: 4px;
  }

  body.light .container {
    background-color: var(--container-bg-light);
    border-color: var(--container-border-light);
  }

  .options-container {
    width: 100%;
    max-width: 400px;
  }

  .preview-container {
    max-width: 800px;
    width: 100%;
    max-height: 40vh;
    background-color: var(--container-bg-dark);
    border-radius: 12px;
    padding: 1rem 2rem 2.75rem 2rem;
    border: 2px solid var(--container-border-dark);
    box-sizing: border-box;
    user-select: none;
    transition: background-color 0.3s, border-color 0.3s;
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 1rem;
    position: relative;
  }

  body.light .preview-container {
    background-color: var(--container-bg-light);
    border-color: var(--container-border-light);
  }

  /* Hide preview heading label */
  .preview-container > h2 {
    display: none;
  }

  label {
    display: block;
    margin-top: 1rem;
    font-family: monospace;
    font-size: 0.85rem;
  }

  select, button {
    font-size: 0.75rem;
    margin-top: 0.25rem;
    padding: 0.25rem 0.5rem;
    width: 100%;
    max-width: 300px;
    border-radius: 6px;
    border: 1px solid #555;
    background-color: transparent;
    color: inherit;
    transition: border-color 0.3s, background-color 0.3s;
    font-family: monospace;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    appearance: none;
    box-sizing: border-box;
  }

  select:focus,
  select:focus-visible {
    outline: none;
    border-color: var(--sakura-pink);
    background-color: var(--select-focus-bg, #222);
  }

  body.light select {
    background-color: #fff;
    border-color: #aaa;
  }

  body.light select:focus,
  body.light select:focus-visible {
    background-color: var(--select-focus-bg-light, #e4f0fc);
  }

  body:not(.light) select {
    background-color: #2a2a2a;
    color: #eee;
  }

  body:not(.light) select option {
    background-color: #2a2a2a;
    color: #eee;
  }

  button {
    font-weight: 700;
    cursor: pointer;
    border: 2px solid var(--sakura-pink);
    background-color: var(--sakura-pink);
    color: #333;
    transition: background-color 0.3s, border-color 0.3s;
  }

  button:hover:not(:disabled),
  button:focus-visible:not(:disabled) {
    background-color: var(--sakura-pink-dark);
    border-color: var(--sakura-pink-dark);
  }

  #exportBtn:disabled {
    background-color: #888;
    cursor: not-allowed;
    color: #ccc;
    border-color: #888;
  }

  .checkbox-group {
    margin-top: 0.25rem;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.35rem 0.7rem;
    max-width: 100%;
    padding: 0.15rem 0;
    justify-items: start;
    font-family: monospace;
    font-size: 0.8rem;
  }

  .checkbox-group label {
    user-select: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.15rem 0.4rem;
    border: 1px solid transparent;
    border-radius: 0.25rem;
    background-color: var(--bg-check, #222);
    transition: background-color 0.3s, border-color 0.3s;
    position: relative;
  }

  body.light .checkbox-group label {
    background-color: #eee;
    color: #111;
  }

  .checkbox-group label:hover,
  .checkbox-group label:focus-within {
    border-color: var(--sakura-pink);
    background-color: var(--bg-check-hover, #333);
  }

  body.light .checkbox-group label:hover,
  body.light .checkbox-group label:focus-within {
    background-color: #d7ecff;
    border-color: #1976d2;
  }

  .checkbox-group input[type=checkbox] {
    cursor: pointer;
  }

  .checkbox-group label::before {
    content: "";
    width: 14px;
    height: 14px;
    flex-shrink: 0;
    border-radius: 2px;
    box-shadow: inset 0 0 0 1.5px rgba(0,0,0,0.3);
    margin-right: 0.4rem;
    background-color: var(--swatch-color, #888);
  }

  #leatherContainer {
    position: relative;
    width: 100%;
    max-width: 700px;
    height: 50px;
    margin-bottom: 1.75rem;
    padding-left: 10%;
    padding-right: 10%;
    box-sizing: border-box;
    margin-left: auto;
    margin-right: auto;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #leatherBar {
    width: 100%;
    height: 100%;
    border-radius: 0;
    box-sizing: border-box;
    position: relative;
    transition: background-color 0.3s, border-color 0.3s;
    border-radius: 4px;
  }

  #leatherBar.black-white-stitch {
    background-color: var(--bw-stitch-black);
  }

  body.light #leatherBar.black-white-stitch {
    border-color: #bbb;
  }

  #leatherBar.black-white-stitch::before,
  #leatherBar.black-white-stitch::after {
    content: "";
    position: absolute;
    height: 0;
    left: 2px;
    right: 2px;
    border-top: 2px dashed white;
    pointer-events: none;
  }

  #leatherBar.black-white-stitch::before {
    top: 2px;
  }

  #leatherBar.black-white-stitch::after {
    bottom: 2px;
  }

  #leatherBar:not(.black-white-stitch)::before,
  #leatherBar:not(.black-white-stitch)::after {
    content: "";
    position: absolute;
    height: 0;
    left: 2px;
    right: 2px;
    border-top: 2px dashed rgba(0,0,0,0.25);
    pointer-events: none;
  }

  #leatherBar:not(.black-white-stitch)::before {
    top: 2px;
  }

  #leatherBar:not(.black-white-stitch)::after {
    bottom: 2px;
  }

  #spikeOverlay {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 11.5%;
    right: 11.5%;
    pointer-events: auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 100%;
  }

  .spike {
    width: 7px;
    height: 7px;
    border-radius: 0;
    outline: 2px solid rgba(48, 48, 48, 0.8);
    box-sizing: border-box;
    cursor: default;
    border: 1px solid rgba(0, 0, 0, 0.2);
  }

  #chainPendantContainer {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 1.25rem;
    max-width: 700px;
    margin: 0 auto;
    overflow: visible;
  }

  #chainLeft, #chainRight {
    display: flex;
    gap: 0.3rem;
    position: relative;
    min-width: 100px;
    min-height: 60px;
    flex-shrink: 0;
    align-items: center;
  }

  #pendantGap {
    display: flex;
    min-width: 70px;
    justify-content: center;
    align-items: center;
    user-select: none;
  }

  #pendantDisplay {
    font-size: 2rem;
    height: 3rem;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .pendant-ring {
    box-sizing: border-box;
    border-style: solid;
    border-width: 0.4rem;
    border-radius: 100%;
    margin: auto;
  }

  .pendant-star {
    margin-top: 40px;
    font-size: 5.25rem;
    user-select: none;
    font-weight: 900;
    color: #fff;
    text-shadow:
      0 0 6px #FFE600,
      0 0 20px #FFE600,
      0 0 30px #FFE600,
      0 0 40px #FFD700,
      0 0 70px #FFD700,
      0 0 80px #FFD700;
  }

  .chain-link {
    border-radius: 50%;
    border: 3px solid rgba(110, 110, 110, 0.15);
    box-sizing: border-box;
    cursor: default;
    transition: background-color 0.3s;
    position: relative;
  }

  .chain-link.small {
    width: 6px;
    height: 6px;
  }

  .chain-link.chunky {
    width: 18px;
    height: 18px;
  }

  select:invalid {
    border: 2px solid #f44336;
    background-color: #fee;
  }

  select:focus-visible,
  input[type=checkbox]:focus-visible + span,
  label:focus-within {
    outline: 2px solid var(--sakura-pink);
    outline-offset: 2px;
  }

  .sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0,0,0,0) !important;
    border: 0 !important;
  }

  .export-container {
    position: relative;
    display: inline-flex;
    width: 100%;
    max-width: 300px;
    margin: 1.75rem auto 1rem;
  }

  #exportBtn {
    border-radius: 6px 0 0 6px;
    margin: 0;
    width: 85%;
  }

  #exportFormatBtn {
    width: 15%;
    margin: 0;
    border-radius: 0 6px 6px 0;
    border-left: none;
    padding: 0;
  }

  .format-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background-color: var(--container-bg-dark);
    border: 1px solid var(--container-border-dark);
    border-radius: 4px;
    z-index: 1000;
    width: auto;
    min-width: 100px;
  }

  body.light .format-dropdown {
    background-color: var(--container-bg-light);
    border-color: var(--container-border-light);
  }

  .format-dropdown.show {
    display: block;
  }

  .format-dropdown button {
    width: 100%;
    text-align: left;
    padding: 8px 12px;
    border: none;
    background: none;
    cursor: pointer;
    border-radius: 0;
  }

  .format-dropdown button:hover {
    background-color: rgba(255, 183, 197, 0.1);
  }

  select:focus,
  select:focus-visible {
    outline: none;
    border-color: var(--sakura-pink);
    background-color: var(--select-focus-bg, #222);
  }

  .saved-designs-container {
    margin-top: 1rem;
    width: 100%;
    max-width: 800px;
    margin: 1rem auto;
    text-align: center;
    
  }

  .saved-designs-actions {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin: 0.5rem 0;
  }

  .saved-designs-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 0.5rem;
  }

  #savedDesignSelector {
    flex: 1;
    margin: 0;
    max-width: none;
  }

  .export-container {
    flex: 0 0 auto;
    display: inline-flex;
    min-width: 140px;
    margin: 0;
  }

  #importInput {
    display: none;
  }

  .mobile-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #333;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    z-index: 9999;
    text-align: center;
    max-width: 90%;
    width: 300px;
  }

  body.light .mobile-popup {
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }

  .mobile-popup button {
    margin-top: 1rem;
    width: auto;
    min-width: 80px;
  }

  .color-tooltip {
    position: fixed;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    z-index: 10000;
    font-family: monospace;
  }

  body.light .color-tooltip {
    background: rgba(255, 255, 255, 0.9);
    color: black;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>
<div class="container-wrapper">
  <button id="modeToggle" aria-label="Toggle light/dark mode" title="Toggle Light & Dark Mode">ðŸŒ™</button>
  <div class="container" role="main" aria-live="polite" aria-atomic="true">
    <section class="options-container" aria-label="Choker customization options">
      <h1>Choker Customizer</h1>

      <label for="orderSelector">Select Previous Order by Timestamp</label>
      <select id="orderSelector" aria-label="Select Previous Order" aria-live="polite" aria-atomic="true" aria-controls="preview" aria-describedby="orderHelp" autocomplete="off">
        <option value="">Loading ordersâ€¦</option>
      </select>
      <div id="orderHelp" class="sr-only" aria-live="polite"></div>

      <!-- Remove choker size dropdown -->
      <label for="baseColor">Base Color *</label>
      <select id="baseColor" aria-required="true" aria-label="Base Color" required autocomplete="off">
        <option value="" disabled selected>-- Select Base Color --</option>
        <option>Black</option>
        <option>Black with White Stitching</option>
        <option>White</option>
        <option>Blue</option>
        <option>Sky Blue</option>
        <option>Red</option>
        <option>Pink</option>
        <option>Purple</option>
      </select>

      <label for="spikeStyle">Spike Style *</label>
      <select id="spikeStyle" aria-required="true" aria-label="Spike Style" required autocomplete="off">
        <option value="" disabled selected>-- Select Spike Style --</option>
        <option>Unselected</option>
        <option>No Spikes</option>
        <option>Solid Color</option>
        <option>Alternating Color</option>
        <option>3 Color Reverse</option>
        <option>Full Color Reverse</option>
        <option>Other</option>
      </select>

      <label id="labelSpikeColors" for="spikeColorsChecklist" style="display:none; margin-top:1rem;">Spike Colors</label>
      <div id="spikeColorsChecklist" class="checkbox-group" aria-labelledby="labelSpikeColors" style="display:none;"></div>

      <label for="chainStyle" style="margin-top:1rem;">Chain Style *</label>
      <select id="chainStyle" aria-required="true" aria-label="Chain Style" required autocomplete="off">
        <option value="" disabled selected>-- Select Chain Style --</option>
        <option>Not Applicable / No Chains</option>
        <option>Small Chains</option>
        <option>Chunky Chains</option>
      </select>

      <label for="smallChainColorPattern" style="margin-top:1rem;display:none;" id="labelSmallChainColorPattern">Small Chain Color Pattern</label>
      <select id="smallChainColorPattern" aria-label="Small Chain Color Pattern" aria-labelledby="labelSmallChainColorPattern" style="display:none; max-width: 300px;" autocomplete="off">
        <option value="" disabled selected>-- Select Small Chain Color Pattern --</option>
        <option>Unselected</option>
        <option>Solid Color</option>
        <option>Half and Half</option>
        <option>2 Color Alternating</option>
        <option>3 Color Alternating</option>
        <option>5 Color Alternating</option>
        <option>Other</option>
      </select>
      <label id="labelSmallChainColors" for="smallChainColorsChecklist" style="margin-top:0.5rem;display:none;">Small Chain Colors</label>
      <div id="smallChainColorsChecklist" class="checkbox-group" aria-labelledby="labelSmallChainColors" style="display:none;"></div>

      <label for="chunkyChainColorPattern" style="margin-top:1rem;display:none;" id="labelChunkyChainColorPattern">Chunky Chain Color Pattern</label>
      <select id="chunkyChainColorPattern" aria-label="Chunky Chain Color Pattern" aria-labelledby="labelChunkyChainColorPattern" style="display:none; max-width: 300px;" autocomplete="off">
        <option value="" disabled selected>-- Select Chunky Chain Color Pattern --</option>
        <option>Unselected</option>
        <option>Solid Color</option>
        <option>Half and Half</option>
        <option>2 Color Alternating</option>
        <option>4 Color Reverse</option>
        <option>Other</option>
      </select>
      <label id="labelChunkyChainColors" for="chunkyChainColorsChecklist" style="margin-top:0.5rem;display:none;">Chunky Chain Colors</label>
      <div id="chunkyChainColorsChecklist" class="checkbox-group" aria-labelledby="labelChunkyChainColors" style="display:none;"></div>

      <label for="pendantStyle" style="margin-top:1rem;">Pendant Style</label>
      <select id="pendantStyle" aria-label="Pendant Style" autocomplete="off">
        <option value="" disabled selected>-- Select Pendant Style --</option>
        <option>None</option>
        <option>O-Ring</option>
        <option>Glow in the Dark Star</option>
        <option>Other</option>
      </select>

      <label for="oRingColor" id="labelORingColor" style="display:none; margin-top:1rem;">O-Ring Color</label>
      <select id="oRingColor" aria-labelledby="labelORingColor" style="display:none;" autocomplete="off">
        <option value="" disabled selected>-- Select O-Ring Color --</option>
        <option>Light</option>
        <option>Dark</option>
      </select>

      <label for="oRingSize" id="labelORingSize" style="display:none; margin-top:0.5rem;">O-Ring Size</label>
      <select id="oRingSize" aria-labelledby="labelORingSize" style="display:none;" autocomplete="off">
        <option value="" disabled selected>-- Select O-Ring Size --</option>
        <option>0.75in</option>
        <option>1.00in</option>
        <option>1.25in</option>
        <option>1.50in</option>
        <option>1.75in</option>
      </select>

      <label for="glowStarColor" id="labelGlowStarColor" style="display:none; margin-top:1rem;">Glow in the Dark Star Color</label>
      <select id="glowStarColor" aria-labelledby="labelGlowStarColor" style="display:none;" autocomplete="off">
        <option value="" disabled selected>-- Select Glow in the Dark Star Color --</option>
        <option>Blue</option>
        <option>Green</option>
        <option>Orange</option>
        <option>Peach</option>
        <option>Pink</option>
        <option>Purple</option>
        <option>White</option>
      </select>

      <div style="height: 1rem"></div>
    </section>
  </div>
</div>

<div class="saved-designs-container">
  <div class="saved-designs-header">
    <p>Saved Designs</p>
    <div class="saved-designs-actions">
      <button id="saveDesign">Save Current</button>
      <input type="file" id="importInput" accept=".json">
      <button id="importDesign" onclick="document.getElementById('importInput').click()">Import</button>
      <button id="exportDesign">Export</button>
      <button id="deleteDesign" class="delete-button" disabled>Delete</button>
    </div>
  </div>
  <div class="saved-designs-controls">
    <select id="savedDesignSelector">
      <option value="">-- Select Saved Design --</option>
    </select>
    <div class="export-container">
      <button id="exportBtn" disabled>Export as PNG</button>
      <button id="exportFormatBtn" aria-haspopup="true" aria-expanded="false">â–¼</button>
      <div class="format-dropdown" id="formatDropdown">
        <button data-format="png">PNG</button>
        <button data-format="jpeg">JPEG</button>
        <button data-format="webp">WEBP</button>
      </div>
    </div>
  </div>
</div>

<section class="preview-container" id="preview" aria-live="polite" aria-atomic="true" tabindex="0" aria-label="Choker Live Preview">
  <div id="leatherContainer" aria-label="Leather base with spikes" role="img">
    <div id="leatherBar" aria-hidden="true"></div>
    <div id="spikeOverlay" role="list" aria-label="Spikes preview"></div>
  </div>
  <div id="chainPendantContainer" aria-label="Chains and pendant preview" role="img">
    <div id="chainLeft" class="chain-segment" role="list" aria-label="Left side chain"></div>
    <div id="pendantGap" aria-label="Pendant preview container">
      <div id="pendantDisplay" aria-label="Pendant preview" role="img"></div>
    </div>
    <div id="chainRight" class="chain-segment" role="list" aria-label="Right side chain"></div>
  </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
(() => {
  const colorMap = {
    "leather": {
      "Black": "var(--black)",
      "Black with White Stitching": "var(--bw-stitch-black)",
      "White": "var(--white-leather)",
      "Blue": "var(--blue-leather)",
      "Sky Blue": "var(--sky-blue-leather)",
      "Red": "var(--red-leather)",
      "Pink": "var(--pink-leather)",
      "Purple": "var(--purple-leather)"
    },
    "spikes": {
      "White": "var(--white-spikes)",
      "Black": "var(--black-spikes)",
      "Gold": "var(--gold-spikes)",
      "Green": "var(--green-spikes)",
      "Gunmetal": "var(--gunmetal-spikes)",
      "Hot Pink": "var(--hot-pink-spikes)",
      "Light Pink": "var(--light-pink-spikes)",
      "Orange": "var(--orange-spikes)",
      "Yellow": "var(--yellow-spikes)",
      "Pink": "var(--pink-spikes)",
      "Purple": "var(--purple-spikes)",
      "Red": "var(--red-spikes)",
      "Sky Blue": "var(--sky-blue-spikes)",
      "Blue": "var(--blue-spikes)"
    },
    "small-chains": {
      "Red": "#D22A25",
      "Orange": "var(--orange)",
      "Translucent Orange": "var(--translucent-orange)",
      "Yellow": "#FFD700",
      "Translucent Yellow": "var(--translucent-yellow)", 
      "Green": "var(--solid-green)",
      "Translucent Green": "var(--translucent-green)",
      "Teal": "var(--solid-teal)",
      "Translucent Teal": "var(--translucent-teal)",
      "Translucent Sky Blue": "var(--translucent-sky-blue)",
      "Blue": "#236cd1",
      "Purple": "var(--solid-purple)",
      "Translucent Lavender": "var(--translucent-lavender)",
      "Hot Pink": "var(--solid-hot-pink)",
      "Pink": "var(--solid-pink)",
      "Translucent Pink": "var(--translucent-pink)",
      "Translucent Salmon": "var(--translucent-salmon)",
      "White": "var(--white-small-chain)"
    },
    "chunky-chains": {
      "Black": "var(--black-chunky)",
      "Blue": "var(--blue-chunky)",
      "Brown": "var(--brown-chunky)",
      "Green": "var(--green-chunky)",
      "Orange": "var(--orange-chunky)",
      "Pink": "var(--pink-chunky)",
      "Purple": "var(--purple-chunky)",
      "Red": "var(--red-chunky)",
      "Sky Blue": "var(--sky-blue-chunky)",
      "Teal": "var(--teal-chunky)",
      "White": "var(--white-chunky)"
    },
    "glow-star": {
      "Blue": "var(--blue-glow-in-the-dark-star)",
      "Green": "var(--green-glow-in-the-dark-star)",
      "Orange": "var(--orange-glow-in-the-dark-star)",
      "Peach": "var(--peach-glow-in-the-dark-star)",
      "Pink": "var(--pink-glow-in-the-dark-star)",
      "Purple": "var(--purple-glow-in-the-dark-star)",
      "White": "var(--white-glow-in-the-dark-star)"
    },
    "pendant": {
      "Light": "var(--light-pendant)",
      "Dark": "var(--dark-pendant)"
    }
  };

  // Helper function to get section-specific color
  function getColor(section, colorName, fallback = '#888888') {
    return colorMap[section]?.[colorName] || fallback;
  }

  const $ = id => document.getElementById(id);

  // Use updated full color arrays consistent with confirmed color names
  const spikeColors = [
    "Red", "Orange", "Yellow", "Gold", "Green",
    "Sky Blue", "Blue", "Purple", "Light Pink",
    "Hot Pink", "White", "Gunmetal", "Black"
  ];

  // Small Chain colors without "(Small Chain)" or "Solid" prefixes removed for checklist
  // Only uses colors exactly as per confirmed names for user checkbox
  const chainColorsSmall = [
    "Red", "Orange", "Translucent Orange", "Yellow", "Translucent Yellow",
    "Green", "Translucent Green", "Teal", "Translucent Teal",
    "Translucent Sky Blue", "Blue", "Purple", "Translucent Lavender",
    "Hot Pink", "Pink", "Translucent Pink", "Translucent Salmon",
    "White"
  ];

  // Chunky chain colors exactly as confirmed names
  const chainColorsChunky = [
    "Red", "Orange", "Brown", "Green", "Teal",
    "Sky Blue", "Blue", "Purple", "Pink", "White",
    "Black"
  ];

  // UI elements
  const orderSelector = $('orderSelector');
  const orderHelp = $('orderHelp');
  const baseColor = $('baseColor');
  const spikeStyle = $('spikeStyle');
  const spikeColorsChecklist = $('spikeColorsChecklist');
  const labelSpikeColors = $('labelSpikeColors');
  const chainStyle = $('chainStyle');
  const smallChainColorPattern = $('smallChainColorPattern');
  const labelSmallChainColorPattern = $('labelSmallChainColorPattern');
  const smallChainColorsChecklist = $('smallChainColorsChecklist');
  const labelSmallChainColors = $('labelSmallChainColors');
  const chunkyChainColorPattern = $('chunkyChainColorPattern');
  const labelChunkyChainColorPattern = $('labelChunkyChainColorPattern');
  const chunkyChainColorsChecklist = $('chunkyChainColorsChecklist');
  const labelChunkyChainColors = $('labelChunkyChainColors');
  const pendantStyle = $('pendantStyle');
  const oRingColor = $('oRingColor');
  const labelORingColor = $('labelORingColor');
  const oRingSize = $('oRingSize');
  const labelORingSize = $('labelORingSize');
  const glowStarColor = $('glowStarColor');
  const labelGlowStarColor = $('labelGlowStarColor');
  const exportBtn = $('exportBtn');
  const exportFormatBtn = $('exportFormatBtn');
  const formatDropdown = $('formatDropdown');

  const leatherBar = $('leatherBar');
  const spikeOverlay = $('spikeOverlay');
  const chainLeft = $('chainLeft');
  const chainRight = $('chainRight');
  const pendantGap = $('pendantGap');
  const pendantDisplay = $('pendantDisplay');

  const saveDesignBtn = $('saveDesign');
  const importDesignBtn = $('importDesign');
  const exportDesignBtn = $('exportDesign');
  const deleteDesignBtn = $('deleteDesign');
  const importInput = $('importInput');
  const savedDesignSelector = $('savedDesignSelector');

  // Load saved designs from localStorage
  function loadSavedDesigns() {
    const designs = JSON.parse(localStorage.getItem('chokerDesigns') || '{}');
    savedDesignSelector.innerHTML = '<option value="">-- Select Saved Design --</option>';
    Object.keys(designs).sort().forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      savedDesignSelector.appendChild(option);
    });
    deleteDesignBtn.disabled = !savedDesignSelector.value;
  }

  // Get current design state
  function getCurrentDesign() {
    return {
      baseColor: baseColor.value,
      spikeStyle: spikeStyle.value,
      spikeColors: [...spikeColorsChecklist.querySelectorAll('input:checked')].map(cb => cb.value),
      chainStyle: chainStyle.value,
      smallChainPattern: smallChainColorPattern.value,
      smallChainColors: [...smallChainColorsChecklist.querySelectorAll('input:checked')].map(cb => cb.value),
      chunkyChainPattern: chunkyChainColorPattern.value,
      chunkyChainColors: [...chunkyChainColorsChecklist.querySelectorAll('input:checked')].map(cb => cb.value),
      pendantStyle: pendantStyle.value,
      oRingColor: oRingColor.value,
      oRingSize: oRingSize.value,
      glowStarColor: glowStarColor.value
    };
  }

  // Apply a saved design
  function applyDesign(design) {
    if (!design) return;
    
    const setSelectValue = (select, value) => {
      if (!select || !value) return;
      select.value = value;
    };

    setSelectValue(baseColor, design.baseColor);
    setSelectValue(spikeStyle, design.spikeStyle);
    setSelectValue(chainStyle, design.chainStyle);
    setSelectValue(smallChainColorPattern, design.smallChainPattern);
    setSelectValue(chunkyChainColorPattern, design.chunkyChainPattern);
    setSelectValue(pendantStyle, design.pendantStyle);
    setSelectValue(oRingColor, design.oRingColor);
    setSelectValue(oRingSize, design.oRingSize);
    setSelectValue(glowStarColor, design.glowStarColor);

    // Reset all checkboxes
    document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(cb => cb.checked = false);

    // Set checked colors
    const setCheckedColors = (container, colors) => {
      if (!colors) return;
      colors.forEach(color => {
        const checkbox = container.querySelector(`input[value="${color}"]`);
        if (checkbox) checkbox.checked = true;
      });
    };

    setCheckedColors(spikeColorsChecklist, design.spikeColors);
    setCheckedColors(smallChainColorsChecklist, design.smallChainColors);
    setCheckedColors(chunkyChainColorsChecklist, design.chunkyChainColors);

    // Update UI state
    updateSpikeColorsVisibility();
    updateSmallChainControls();
    updateChunkyChainControls();
    updatePendantControls();
    updatePreviewAndValidation();
  }

  // Save current design
  saveDesignBtn.addEventListener('click', () => {
    const name = prompt('Enter a name for this design:');
    if (!name) return;

    const designs = JSON.parse(localStorage.getItem('chokerDesigns') || '{}');
    designs[name] = getCurrentDesign();
    localStorage.setItem('chokerDesigns', JSON.stringify(designs));
    loadSavedDesigns();
    savedDesignSelector.value = name;
    deleteDesignBtn.disabled = false;
  });

  // Load selected design
  savedDesignSelector.addEventListener('change', () => {
    const name = savedDesignSelector.value;
    deleteDesignBtn.disabled = !name;
    if (!name) return;

    const designs = JSON.parse(localStorage.getItem('chokerDesigns') || '{}');
    const design = designs[name];
    if (design) {
      applyDesign(design);
    }
  });

  // Import design from file
  importDesignBtn.addEventListener('click', () => {
    importInput.click();
  });

  importInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const design = JSON.parse(e.target.result);
        applyDesign(design);
      } catch (err) {
        alert('Invalid design file');
      }
    };
    reader.readAsText(file);
    importInput.value = ''; // Reset input
  });

  // Export current design
  exportDesignBtn.addEventListener('click', () => {
    const design = getCurrentDesign();
    const blob = new Blob([JSON.stringify(design, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'choker-design.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // Delete selected design
  deleteDesignBtn.addEventListener('click', () => {
    const name = savedDesignSelector.value;
    if (!name) return;

    if (!confirm(`Are you sure you want to delete the design "${name}"?`)) return;

    const designs = JSON.parse(localStorage.getItem('chokerDesigns') || '{}');
    delete designs[name];
    localStorage.setItem('chokerDesigns', JSON.stringify(designs));
    loadSavedDesigns();
    deleteDesignBtn.disabled = true;
  });

  // Populate checklist helper
  function populateChecklist(container, colors) {
    container.innerHTML = "";
    const containerType = container.id.replace('Checklist', '').replace('Colors', '');
    
    colors.forEach(color => {
      const id = container.id + "_" + color.replace(/\s+/g, '');
      const label = document.createElement('label');
      const section = containerType === 'spike' ? 'spikes' :
                     containerType === 'smallChain' ? 'small-chains' :
                     containerType === 'chunkyChain' ? 'chunky-chains' : '';
      
      label.style.setProperty('--swatch-color', getColor(section, color, '#888'));
      label.htmlFor = id;
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = id;
      checkbox.name = container.id;
      checkbox.value = color;
      const span = document.createElement('span');
      span.textContent = color;
      label.appendChild(checkbox);
      label.appendChild(span);
      container.appendChild(label);
    });
  }

  function updateSpikeColorsVisibility() {
    const val = spikeStyle.value;
    if(val && !["No Spikes","Unselected"].includes(val)) {
      spikeColorsChecklist.style.display = 'grid';
      labelSpikeColors.style.display = 'block';
    } else {
      spikeColorsChecklist.style.display = 'none';
      labelSpikeColors.style.display = 'none';
      [...spikeColorsChecklist.querySelectorAll('input[type=checkbox]')].forEach(cb => cb.checked = false);
    }
  }
  function updateSmallChainControls() {
    if(chainStyle.value === 'Small Chains') {
      smallChainColorPattern.style.display = 'block';
      labelSmallChainColorPattern.style.display = 'block';
      if (
        smallChainColorPattern.value &&
        smallChainColorPattern.value !== "Unselected"
      ) {
        smallChainColorsChecklist.style.display = 'grid';
        labelSmallChainColors.style.display = 'block';
      } else {
        smallChainColorsChecklist.style.display = 'none';
        labelSmallChainColors.style.display = 'none';
        [...smallChainColorsChecklist.querySelectorAll('input[type=checkbox]')].forEach(cb => cb.checked = false);
      }
    } else {
      smallChainColorPattern.style.display = 'none';
      labelSmallChainColorPattern.style.display = 'none';
      smallChainColorsChecklist.style.display = 'none';
      labelSmallChainColors.style.display = 'none';
      [...smallChainColorsChecklist.querySelectorAll('input[type=checkbox]')].forEach(cb => cb.checked = false);
      smallChainColorPattern.value = '';
    }
  }
  function updateChunkyChainControls() {
    if(chainStyle.value === 'Chunky Chains') {
      chunkyChainColorPattern.style.display = 'block';
      labelChunkyChainColorPattern.style.display = 'block';
      if (
        chunkyChainColorPattern.value &&
        chunkyChainColorPattern.value !== "Unselected"
      ) {
        chunkyChainColorsChecklist.style.display = 'grid';
        labelChunkyChainColors.style.display = 'block';
      } else {
        chunkyChainColorsChecklist.style.display = 'none';
        labelChunkyChainColors.style.display = 'none';
        [...chunkyChainColorsChecklist.querySelectorAll('input[type=checkbox]')].forEach(cb => cb.checked = false);
      }
    } else {
      chunkyChainColorPattern.style.display = 'none';
      labelChunkyChainColorPattern.style.display = 'none';
      chunkyChainColorsChecklist.style.display = 'none';
      labelChunkyChainColors.style.display = 'none';
      [...chunkyChainColorsChecklist.querySelectorAll('input[type=checkbox]')].forEach(cb => cb.checked = false);
      chunkyChainColorPattern.value = '';
    }
  }
  function updatePendantControls() {
    if(pendantStyle.value === 'O-Ring') {
      oRingColor.style.display = 'block';
      labelORingColor.style.display = 'block';
      oRingSize.style.display = 'block';
      labelORingSize.style.display = 'block';
      glowStarColor.style.display = 'none';
      labelGlowStarColor.style.display = 'none';
      glowStarColor.value = '';
    } else if(pendantStyle.value === 'Glow in the Dark Star') {
      glowStarColor.style.display = 'block';
      labelGlowStarColor.style.display = 'block';
      oRingColor.style.display = 'none';
      labelORingColor.style.display = 'none';
      oRingSize.style.display = 'none';
      labelORingSize.style.display = 'none';
      oRingColor.value = '';
      oRingSize.value = '';
    } else {
      oRingColor.style.display = 'none';
      labelORingColor.style.display = 'none';
      oRingSize.style.display = 'none';
      labelORingSize.style.display = 'none';
      glowStarColor.style.display = 'none';
      labelGlowStarColor.style.display = 'none';
      oRingColor.value = '';
      oRingSize.value = '';
      glowStarColor.value = '';
    }
  }

  // CSV load and sorting
  async function loadOrdersFromCSV() {
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSbXUcpajGaza9RMnJ-5Vw4LRv_EhcCh6BNwjCndjCKBL2biwRL0CViS6ut9RZk0BOWJz4PrhlQKdVm/pub?output=csv';
    try {
      const response = await fetch(csvUrl);
      if(!response.ok) throw new Error('Fetching CSV failed');
      const csvText = await response.text();
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      const idx = colName => headers.findIndex(h => h.includes(colName));
      const orderData = {};
      const orderEntries = [];
      for(let i=1; i<lines.length; i++) {
        if(!lines[i]) continue;
        let cols = [];
        let inQuotes = false, cur = '';
        for(let c of lines[i]) {
          if(c === '"') inQuotes = !inQuotes;
          else if(c === ',' && !inQuotes) {
            cols.push(cur);
            cur = '';
          } else cur += c;
        }
        cols.push(cur);
        cols = cols.map(s => s.trim().replace(/^"(.*)"$/,'$1'));
        const timestamp = cols[idx('timestamp')] || `Order ${i}`;
        const order = {
          timestamp,
          baseColor: cols[idx('base color')] || '',
          spikeStyle: cols[idx('spike style')] || '',
          spikeColors: cols[idx('spike colors')] || '',
          chainStyle: cols[idx('chain style')] || '',
          smallChainPattern: cols[idx('small chain color pattern')] || '',
          smallChainColors: cols[idx('small chain colors')] || '',
          chunkyChainPattern: cols[idx('chunky chain color pattern')] || '',
          chunkyChainColors: cols[idx('chunky chain colors')] || '',
          pendantStyle: cols[idx('pendant style')] || '',
          oRingColor: cols[idx('o-ring color')] || '',
          oRingSize: cols[idx('o-ring size')] || '',
          glowStarColor: (() => {
  const possibleHeaders = [
    'glow in the dark star color',
    'glowinthedarkstarcolor',
    'glow star color', // fallback
    'glowstarcolor'
  ];
  for (const h of possibleHeaders) {
    const i = headers.findIndex(x => x.includes(h));
    if (i !== -1) return cols[i] || '';
  }
  return '';
})(),
        };
        orderEntries.push(order);
      }
      orderEntries.sort((a,b) => b.timestamp.localeCompare(a.timestamp));
      let htmlOptions = `<option value="">-- Select Previous Order --</option>`;
      orderEntries.forEach(order => {
        htmlOptions += `<option value="${order.timestamp}">${order.timestamp}</option>`;
        orderData[order.timestamp] = order;
      });
      orderSelector.innerHTML = htmlOptions;
      orderSelector._orderData = orderData;
    } catch(e) {
      console.warn('CSV load error:', e);
      orderSelector.innerHTML = `<option value="">No orders available</option>`;
      orderSelector._orderData = {};
    }
  }

  orderSelector.addEventListener('change', () => {
    const ts = orderSelector.value;
    const orders = orderSelector._orderData || {};
    const order = orders[ts];
    if(!order) return;

    const setSelectVal = (select, val) => {
      if(!select || !val) return;
      val = val.toString().trim();
      // Handle special case for O-Ring size which may come as number or text
      if (select === oRingSize) {
        // Convert inches format if needed
        if (!val.endsWith('in')) {
          const num = parseFloat(val);
          if (!isNaN(num)) {
            val = num.toFixed(2) + 'in';
          }
        }
        const matchingOption = Array.from(select.options).find(o => 
          o.text.toLowerCase() === val.toLowerCase()
        );
        select.value = matchingOption ? matchingOption.text : '';
        return;
      }
      const option = Array.from(select.options).find(o => 
        o.text.trim().toLowerCase() === val.toLowerCase()
      );
      select.value = option ? option.text : "";
    };

    setSelectVal(baseColor, order.baseColor);
    setSelectVal(spikeStyle, order.spikeStyle);
    setSelectVal(chainStyle, order.chainStyle);
    setSelectVal(smallChainColorPattern, order.smallChainPattern);
    setSelectVal(chunkyChainColorPattern, order.chunkyChainPattern);
    setSelectVal(pendantStyle, order.pendantStyle);
    setSelectVal(oRingColor, order.oRingColor);
    setSelectVal(oRingSize, order.oRingSize);
    setSelectVal(glowStarColor, order.glowStarColor);

    [...spikeColorsChecklist.querySelectorAll('input[type=checkbox]')].forEach(cb=>{cb.checked=false;});
    [...smallChainColorsChecklist.querySelectorAll('input[type=checkbox]')].forEach(cb=>{cb.checked=false;});
    [...chunkyChainColorsChecklist.querySelectorAll('input[type=checkbox]')].forEach(cb=>{cb.checked=false;});

    const parseCheckboxString = s => new Set(
      s.toLowerCase().split(/[,;]/).map(v => v.trim()).filter(Boolean)
    );

    const setCheckboxes = (container, values) => {
      const setVals = parseCheckboxString(values || '');
      container.querySelectorAll('input[type=checkbox]').forEach(cb => {
        // Compare normalized color names ignoring case and spaces for better matching
        cb.checked = Array.from(setVals).some(v => v === cb.value.toLowerCase());
      });
    };

    setCheckboxes(spikeColorsChecklist, order.spikeColors);
    setCheckboxes(smallChainColorsChecklist, order.smallChainColors);
    setCheckboxes(chunkyChainColorsChecklist, order.chunkyChainColors);

    updateSpikeColorsVisibility();
    updateSmallChainControls();
    updateChunkyChainControls();
    updatePendantControls();
    updatePreviewAndValidation();

    orderHelp.textContent = `Loaded order: ${ts}`;
  });

  // Spike render with corrected patterns and modifiers
  function renderSpikes() {
    spikeOverlay.innerHTML = "";
    if (!spikeStyle.value || spikeStyle.value === "No Spikes" || spikeStyle.value === "Unselected") return;

    const baseCount = pendantStyle.value === 'O-Ring' ? 10 : 11;
    const checkedColors = [...spikeColorsChecklist.querySelectorAll('input[type=checkbox]:checked')]
      .map(cb => cb.value);

    if (checkedColors.length < 1) return;

    const hasMiddle = baseCount % 2 === 1;
    const sideCount = Math.floor(baseCount / 2);
    
    // Generate the pattern for the left side
    const leftPattern = [];
    for (let i = 0; i < sideCount; i++) {
      switch (spikeStyle.value) {
        case 'Alternating Color':
          // Fix alternating pattern to use proper modulo
          if (checkedColors.length >= 2) {
            leftPattern.push(checkedColors[Math.floor(i % checkedColors.length)]);
          } else {
            leftPattern.push(checkedColors[0]);
          }
          break;
        case '3 Color Reverse':
        const seq3 = [0, 1, 2, 1, 0, 2, 0, 1, 2, 1, 0];
          leftPattern.push(checkedColors[seq3[i % seq3.length]]);
          break;
        case 'Full Color Reverse': {
          const n = checkedColors.length;
          const totalPattern = n * 2;
          let idx = i % totalPattern;
          if (idx >= n) idx = totalPattern - 1 - idx;
          leftPattern.push(checkedColors[idx]);
          break;
        }
        default: // Solid Color
          leftPattern.push(checkedColors[0]);
      }
    }

    // Create right pattern by mirroring left
    const rightPattern = [...leftPattern].reverse();
    
    // Get middle spike color based on pattern type
    const getMiddleColor = () => {
      switch (spikeStyle.value) {
        case 'Alternating Color':
          return checkedColors[sideCount % checkedColors.length];
        case '3 Color Reverse':
          return checkedColors[0]; // Center point of reverse
        case 'Full Color Reverse':
          return checkedColors[0]; // Reset point for reverse
        default:
          return checkedColors[0];
      }
    };

    // Combine patterns with middle spike if needed
    const fullPattern = [
      ...leftPattern,
      ...(hasMiddle ? [getMiddleColor()] : []),
      ...rightPattern
    ];

    // Render all spikes
    fullPattern.forEach(color => {
      const spike = document.createElement('div');
      spike.className = 'spike';
      const swatchColor = getSwatchColor(spikeColorsChecklist, color);
      spike.style.backgroundColor = swatchColor || getColor('spikes', color, '#888888');
      if (spikeStyle.value === 'Full Color Reverse') {
        spike.style.outline = '2px solid rgba(100, 100, 100, 0.8)';
      }
      spike.addEventListener('mouseover', (e) => showTooltip(color, e));
      spike.addEventListener('mouseout', hideTooltip);
      spike.addEventListener('mousemove', (e) => showTooltip(color, e));
      spikeOverlay.appendChild(spike);
    });
  }

  // Update leather base color and styling
  function updateLeatherBar() {
    if(baseColor.value === 'Black with White Stitching')
    {
      leatherBar.classList.add('black-white-stitch');
      leatherBar.style.backgroundColor = getColor('leather', 'Black with White Stitching', '#000000');
      leatherBar.style.borderColor = getComputedStyle(document.body).getPropertyValue('--container-border-dark').trim() || '#444444';
    } 
    else {
      leatherBar.classList.remove('black-white-stitch');
      leatherBar.style.backgroundColor = getColor('leather', baseColor.value, '#333333');
      leatherBar.style.borderColor = 'transparent';
    }
  }

  // Update pendant display
  function updatePendant() {
    pendantDisplay.innerHTML = "";
    if(!pendantStyle.value || pendantStyle.value === "None")
    {
      pendantGap.style.display = 'none';
      return;
    }
    pendantGap.style.display = 'flex';
    if(pendantStyle.value === "O-Ring") {
      const ring = document.createElement('div');
      ring.className = 'pendant-ring';
      let color = '#cccccc';
      if(oRingColor.value === 'Light') color = getColor('pendant', 'Light', '#cccccc');
      if(oRingColor.value === 'Dark') color = getColor('pendant', 'Dark', '#444444');
      ring.style.borderColor = color;
      const sizeMap = { 
        '0.75in': 40,
        '1.00in': 50, 
        '1.25in': 60,
        '1.50in': 70,
        '1.75in': 80
      };
      const sizePx = sizeMap[oRingSize.value] || 32;
      ring.style.width = sizePx + 'px';
      ring.style.height = sizePx + 'px';
      pendantDisplay.appendChild(ring);
    } else if(pendantStyle.value === "Glow in the Dark Star") {
      const star = document.createElement('span');
      star.className = 'pendant-star';
      star.textContent = 'â˜…';
      const glowColor = glowStarColor.value;
      const displayColor = glowColor ? getColor('glow-star', glowColor, '#ffffff') : '#ffffff';
      star.style.color = displayColor;
      star.style.textShadow = `0 0 3px ${displayColor}, 0 0 10px ${displayColor}, 0 0 0px ${displayColor}, 0 0 40px ${displayColor}`;
      if (glowColor) {
        star.addEventListener('mouseover', (e) => showTooltip(glowColor, e));
        star.addEventListener('mouseout', hideTooltip);
        star.addEventListener('mousemove', (e) => showTooltip(glowColor, e));
      }
      pendantDisplay.appendChild(star);
    } else {
      pendantGap.style.display = 'none';
    }
  }

  // Update entire preview & validation and re-render chains/spikes/pendants
  function updatePreviewAndValidation() {
    const valid = !!baseColor.value && !!spikeStyle.value && !!chainStyle.value;
    exportBtn.disabled = !valid;
    updateLeatherBar();
    renderSpikes();
    updatePendant();

    // Update to use values instead of mapped colors for chains
    const smallColorsChecked = [...smallChainColorsChecklist.querySelectorAll('input[type=checkbox]:checked')]
      .map(cb => cb.value);
    const chunkyColorsChecked = [...chunkyChainColorsChecklist.querySelectorAll('input[type=checkbox]:checked')]
      .map(cb => cb.value);

    chainLeft.innerHTML = "";
    chainRight.innerHTML = "";

    if(chainStyle.value === "Small Chains") {
      const colors = generateSymmetricChainColors(smallChainColorPattern.value, smallColorsChecked, 40);
      renderSymmetricChainLinks(chainLeft, "small-chains", colors.left);
      renderSymmetricChainLinks(chainRight, "small-chains", colors.right);
    } else if(chainStyle.value === "Chunky Chains") {
      const colors = generateSymmetricChainColors(chunkyChainColorPattern.value, chunkyColorsChecked, 16);
      renderSymmetricChainLinks(chainLeft, "chunky-chains", colors.left);
      renderSymmetricChainLinks(chainRight, "chunky-chains", colors.right);
    }
  }

  // Generate symmetrical color arrays for chain links (half mirrored to right side)
  function generateSymmetricChainColors(pattern, colorChoices, count) {
    if(!pattern || pattern === "Unselected") {
      const col = colorChoices[0] || "#777777";
      return { left: new Array(count / 2).fill(col), right: new Array(count / 2).fill(col) };
    }
    const half = count / 2;
    let leftColors = [];
    switch(pattern) {
      case "Solid Color":
        leftColors = new Array(half).fill(colorChoices[0]);
        break;
      case "Half and Half": {
        const halfHalf = Math.floor(half / 2);
        leftColors = new Array(halfHalf).fill(colorChoices[0]);
        if(half % 2 !== 0) leftColors.push(colorChoices[0]);
        leftColors = leftColors.concat(new Array(halfHalf).fill(colorChoices[1]));
        break;
      }
      case "2 Color Alternating":
        leftColors = new Array(half).fill(null).map((_, i) => colorChoices[i % 2]);
        break;
      case "3 Color Alternating":
        leftColors = new Array(half).fill(null).map((_, i) => colorChoices[i % 3]);
        break;
      case "4 Color Reverse": {
        const seq = [0,1,2,3,3,2,1,0];
        leftColors = new Array(half).fill(null).map((_, i) => colorChoices[seq[i % 8]] || colorChoices[0]);
        break;
      }
      case "5 Color Alternating":
        leftColors = new Array(half).fill(null).map((_, i) => colorChoices[i % 5]);
        break;
      default:
        leftColors = new Array(half).fill(colorChoices[0]);
        break;
    }
    // Right colors mirror left colors reversed
    const rightColors = [...leftColors].reverse();
    return { left: leftColors, right: rightColors };
  }

  // Update chain rendering to use section-specific colors
  function renderSymmetricChainLinks(container, section, colors) {
    container.innerHTML = "";
    if(!colors.length) {
      container.style.alignItems = "initial";
      return;
    }
    
    colors.forEach(color => {
      const link = document.createElement('div');
      link.classList.add('chain-link');
      const checklist = section === "small-chains" ? smallChainColorsChecklist : chunkyChainColorsChecklist;
      const swatchColor = getSwatchColor(checklist, color);
      link.style.backgroundColor = swatchColor || getColor(section, color, "#777777");
      link.classList.add(section === "small-chains" ? 'small' : 'chunky');
      link.addEventListener('mouseover', (e) => showTooltip(color, e));
      link.addEventListener('mouseout', hideTooltip);
      link.addEventListener('mousemove', (e) => showTooltip(color, e));
      container.appendChild(link);
    });
    
    container.style.alignItems = "center";
    // Use different layout functions based on chain type
    if (section === "small-chains") {
      layoutSmallChainUShape(container);
    } else {
      layoutChunkyChainUShape(container);
    }
  }

  // Small chain links layout with subtle U shape
  function layoutSmallChainUShape(container) {
    const count = container.children.length;
    if(count === 0) return;
    const a = -0.70; // Steeper curve for small chains
    const h = (count - 1) / 2;
    const k = 18;
    for(let i=0; i<count; i++) {
      const x = i;
      const y = a * (x - h) * (x - h) + k;
      const link = container.children[i];
      link.style.position = "relative";
      link.style.top = y + "px";
    }
  }

  // Chunky chain links layout with gentler U shape
  function layoutChunkyChainUShape(container) {
    const count = container.children.length;
    if(count === 0) return;
    const a = -3.85; // Gentler curve for chunky chains
    const h = (count - 1) / 2;
    const k = 15; // Slightly lower peak
    for(let i=0; i<count; i++) {
      const x = i;
      const y = a * (x - h) * (x - h) + k;
      const link = container.children[i];
      link.style.position = "relative";
      link.style.top = y + "px";
    }
  }

  exportBtn.addEventListener("click", async () => {
    const format = exportFormatBtn.dataset.format || "png";
    exportBtn.disabled = true;
    exportBtn.textContent = `Exporting ${format.toUpperCase()}...`;
    try {
      const canvas = await html2canvas($("preview"), {
        backgroundColor: null,
        scale: 2,
        scrollY: -window.scrollY,
      });
      canvas.toBlob((blob) => {
        if (!blob) {
          alert("Export failed: could not create image blob.");
          exportBtn.disabled = false;
          exportBtn.textContent = `Export as ${format.toUpperCase()}`;
          return;
        }
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `choker-preview.${format}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        exportBtn.disabled = false;
        exportBtn.textContent = `Export as ${format.toUpperCase()}`;
      }, `image/${format}`);
    } catch (e) {
      alert("Export failed: " + e.message);
      exportBtn.disabled = false;
      exportBtn.textContent = `Export as ${format.toUpperCase()}`;
    }
  });

  exportFormatBtn.addEventListener("click", () => {
    const isExpanded = exportFormatBtn.getAttribute("aria-expanded") === "true";
    exportFormatBtn.setAttribute("aria-expanded", !isExpanded);
    formatDropdown.classList.toggle("show");
  });

  formatDropdown.addEventListener("click", (e) => {
    if (e.target.tagName === "BUTTON") {
      const format = e.target.dataset.format;
      exportFormatBtn.dataset.format = format;
      exportBtn.textContent = `Export as ${format.toUpperCase()}`;
      exportFormatBtn.setAttribute("aria-expanded", false);
      formatDropdown.classList.remove("show");
    }
  });

  // Add click outside listener to close dropdown
  document.addEventListener("click", (e) => {
    if (!exportFormatBtn.contains(e.target) && !formatDropdown.contains(e.target)) {
      exportFormatBtn.setAttribute("aria-expanded", false);
      formatDropdown.classList.remove("show");
    }
  });

  // Dark mode toggle button with icon and aria-label switching
  const modeToggle = document.getElementById('modeToggle');
  function updateModeIcon() {
    if(document.body.classList.contains('light')) {
      modeToggle.textContent = 'â˜€ï¸';
      modeToggle.title = 'Switch to Dark Mode';
      modeToggle.setAttribute('aria-label', 'Switch to Dark Mode');
    } else {
      modeToggle.textContent = 'ðŸŒ™';
      modeToggle.title = 'Switch to Light Mode';
      modeToggle.setAttribute('aria-label', 'Switch to Light Mode');
    }
  }
  modeToggle.addEventListener('click', () => {
    document.body.classList.toggle('light');
    updateModeIcon();
  });
  updateModeIcon();

  // Bind inputs and checkboxes to update UI dynamically
  const inputs = [baseColor, spikeStyle, chainStyle, smallChainColorPattern,
    chunkyChainColorPattern, pendantStyle, oRingColor, oRingSize, glowStarColor];
  inputs.forEach(el => el.addEventListener('change', () => {
    updateSpikeColorsVisibility();
    updateSmallChainControls();
    updateChunkyChainControls();
    updatePendantControls();
    updatePreviewAndValidation();
  }));
  [spikeColorsChecklist, smallChainColorsChecklist, chunkyChainColorsChecklist].forEach(container => {
    container.addEventListener('change', updatePreviewAndValidation);
  });

  window.addEventListener('DOMContentLoaded', () => {
    // Check if mobile
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        document.getElementById('mobilePopup').style.display = 'block';
    }
    
    populateChecklist(spikeColorsChecklist, spikeColors);
    populateChecklist(smallChainColorsChecklist, chainColorsSmall);
    populateChecklist(chunkyChainColorsChecklist, chainColorsChunky);
    loadOrdersFromCSV();
    updateSpikeColorsVisibility();
    updateSmallChainControls();
    updateChunkyChainControls();
    updatePendantControls();
    updatePreviewAndValidation();
    // Set initial format and button text
    exportFormatBtn.dataset.format = "png";
    exportBtn.textContent = "Export as PNG";
    loadSavedDesigns();
  });

  function dismissMobilePopup() {
    document.getElementById('mobilePopup').style.display = 'none';
  }

  // Add tooltip handling functions after other variable declarations
  let tooltip = null;

  function showTooltip(text, event) {
    if (!tooltip) {
      tooltip = document.createElement('div');
      tooltip.className = 'color-tooltip';
      document.body.appendChild(tooltip);
    }
    tooltip.textContent = text;
    tooltip.style.display = 'block';
    tooltip.style.left = (event.clientX + 10) + 'px';
    tooltip.style.top = (event.clientY + 10) + 'px';
  }

  function hideTooltip() {
    if (tooltip) {
      tooltip.style.display = 'none';
    }
  }

  // Add helper function after colorMap definition
  function getSwatchColor(container, colorName) {
    const checkbox = container.querySelector(`input[value="${colorName}"]`);
    if (!checkbox) return null;
    const label = checkbox.closest('label');
    if (!label) return null;
    return getComputedStyle(label).getPropertyValue('--swatch-color').trim();
  }

})();
</script>
<div id="mobilePopup" class="mobile-popup">
    <p>For best experience, please enable desktop site. Thank you.</p>
    <button onclick="dismissMobilePopup()">OK</button>
</div>
</body>
</html>
