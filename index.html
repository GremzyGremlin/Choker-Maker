<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Choker Customizer</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }

    .scroll-wrapper {
      width: 600px;
      height: 900px;
      margin: 0 auto;
      overflow-y: auto;
      padding: 20px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    label {
      display: block;
      margin: 10px 0 5px;
    }

    .checklist {
      width: 300px;
      height: 100px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background: #fafafa;
      margin-bottom: 10px;
    }

    .checklist label {
      display: block;
    }

    #preview {
      margin-top: 30px;
      padding: 20px;
      border: 2px dashed #aaa;
      background: #bdbdbd;
    }

    .bar {
      width: 300px;
      height: 30px;
      position: relative;
      margin: 10px auto;
      border: 2px solid black;
    }

    #leatherBar {
      width: 100%;
      height: 100%;
    }

    .spike-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      z-index: 2;
    }

    .spike {
      width: 6px;
      height: 6px;
    }

    .chain-preview {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 2px;
      margin: 10px 0;
    }

    .chain-symbol {
      display: inline-block;
      border-radius: 50%;
    }

    .chunky {
      width: 20px;
      height: 20px;
    }

    .small {
      width: 10px;
      height: 10px;
    }

    .chain-gap {
      width: 60px;
      height: 1px;
    }

    .pendant-preview {
      font-size: 72px;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 20px;
    }

    #saveImageBtn, #loadOrderBtn {
      display: block;
      margin: 20px auto 0;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="scroll-wrapper">
  <h1>Design Your Choker</h1>

  <label for="orderSelect">Select an Order</label>
  <select id="orderSelect">
    <option disabled selected>Choose...</option>
  </select>
  <button id="loadOrderBtn">Load Order</button>

  <label for="leather">Leather Color</label>
  <select id="leather"></select>

  <label>Spike Colors</label>
  <div id="spikeColorsChecklist" class="checklist"></div>

  <label for="chainStyle">Chain Style</label>
  <select id="chainStyle">
    <option value="none">None</option>
    <option value="small">Small</option>
    <option value="chunky">Chunky</option>
  </select>

  <label for="chainColorMode">Chain Color Mode</label>
  <select id="chainColorMode">
    <option value="alternating">Alternating</option>
    <option value="split">Split in Half</option>
  </select>

  <label>Chain Colors</label>
  <div id="chainColorsChecklist" class="checklist"></div>

  <label for="pendant">Pendant Color</label>
  <select id="pendant"></select>

  <div id="preview">
    <h2>Preview</h2>
    <div id="leatherPreview" class="bar">
      <div id="leatherBar"></div>
      <div id="spikeOverlay" class="spike-overlay"></div>
    </div>
    <div id="chainPreview" class="chain-preview"></div>
    <div id="pendantPreview" class="pendant-preview"></div>
  </div>

  <button id="saveImageBtn">Save as Image</button>
</div>

<script>
const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSbXUcpajGaza9RMnJ-5Vw4LRv_EhcCh6BNwjCndjCKBL2biwRL0CViS6ut9RZk0BOWJz4PrhlQKdVm/pub?output=csv';

const leatherSelect = document.getElementById("leather");
const spikeChecklist = document.getElementById("spikeColorsChecklist");
const chainChecklist = document.getElementById("chainColorsChecklist");
const pendantSelect = document.getElementById("pendant");
const orderSelect = document.getElementById("orderSelect");

const colors = ["black", "white", "silver", "gold", "pink", "red", "orange", "yellow", "green", "blue", "purple"];

function populateSelect(select, options) {
  select.innerHTML = options.map(color => `<option value="${color}">${color}</option>`).join("");
}

function populateChecklist(container, options) {
  container.innerHTML = options.map(color =>
    `<label><input type="checkbox" value="${color}"> ${color}</label>`
  ).join("");
}

function getCheckedValues(containerId) {
  return Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(el => el.value);
}

function setCheckedValues(containerId, values) {
  const checkboxes = document.querySelectorAll(`#${containerId} input[type='checkbox']`);
  checkboxes.forEach(box => box.checked = values.includes(box.value));
}

function populateFormFromData(data) {
  document.getElementById("leather").value = data.leather;
  setCheckedValues("spikeColorsChecklist", data.spikes);
  document.getElementById("chainStyle").value = data.chainStyle;
  document.getElementById("chainColorMode").value = data.chainMode;
  setCheckedValues("chainColorsChecklist", data.chainColors);
  document.getElementById("pendant").value = data.pendant;
  updatePreview();
}

fetch(sheetUrl)
  .then(res => res.text())
  .then(csv => {
    const [header, ...rows] = csv.trim().split("\n").map(r => r.split(","));
    window.orderData = rows.map((r, i) => ({
      name: `Order ${i + 1}`,
      leather: r[1],
      spikes: r[2].split(";"),
      chainStyle: r[3],
      chainMode: r[4],
      chainColors: r[5].split(";"),
      pendant: r[6]
    }));
    orderData.forEach((order, idx) => {
      const opt = document.createElement("option");
      opt.value = idx;
      opt.textContent = order.name;
      orderSelect.appendChild(opt);
    });
  });

document.getElementById("loadOrderBtn").addEventListener("click", () => {
  const idx = orderSelect.value;
  if (idx !== "") {
    populateFormFromData(window.orderData[idx]);
  }
});

// Populate dropdowns and checklists with initial colors
populateSelect(leatherSelect, colors);
populateChecklist(spikeChecklist, colors);
populateChecklist(chainChecklist, colors);
populateSelect(pendantSelect, colors);

function updatePreview() {
  const leather = document.getElementById("leather").value;
  const spikes = getCheckedValues("spikeColorsChecklist");
  const chainStyle = document.getElementById("chainStyle").value;
  const chainMode = document.getElementById("chainColorMode").value;
  const chainColors = getCheckedValues("chainColorsChecklist");
  const pendant = document.getElementById("pendant").value;

  document.getElementById("leatherBar").style.background = leather;

  const spikeOverlay = document.getElementById("spikeOverlay");
  spikeOverlay.innerHTML = "";
  spikes.forEach(color => {
    const s = document.createElement("div");
    s.className = "spike";
    s.style.background = color;
    spikeOverlay.appendChild(s);
  });

  const chainPreview = document.getElementById("chainPreview");
  chainPreview.innerHTML = "";
  if (chainStyle !== "none") {
    const chunkClass = chainStyle === "chunky" ? "chunky" : "small";
    const total = 20;
    for (let i = 0; i < total; i++) {
      const color = chainMode === "split"
        ? chainColors[Math.floor(i / (total / chainColors.length)) % chainColors.length]
        : chainColors[i % chainColors.length];
      const elem = document.createElement("div");
      elem.className = `chain-symbol ${chunkClass}`;
      elem.style.background = color;
      chainPreview.appendChild(elem);
    }
  }

  document.getElementById("pendantPreview").textContent = "\u2731";
  document.getElementById("pendantPreview").style.color = pendant;
}

document.querySelectorAll("select, input").forEach(el => {
  el.addEventListener("change", updatePreview);
});

document.getElementById("saveImageBtn").addEventListener("click", () => {
  html2canvas(document.getElementById("preview")).then(canvas => {
    const link = document.createElement('a');
    link.download = 'choker-preview.png';
    link.href = canvas.toDataURL();
    link.click();
  });
});
</script>
</body>
</html>
